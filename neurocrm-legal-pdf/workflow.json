{
  "name": "neuroCRM (test)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "fbc4cb53-5f89-43ac-8cb8-74c12dd8b97b",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        0,
        -160
      ],
      "id": "94f5d8bf-712a-4fb3-b8a8-33869883cf34",
      "name": "Webhook",
      "webhookId": "fbc4cb53-5f89-43ac-8cb8-74c12dd8b97b"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "fabe5f41-d595-4e68-b1b6-62b63df2b090",
              "leftValue": "={{ $json.body.event }}",
              "rightValue": "ONCRMDEALADD",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        224,
        -160
      ],
      "id": "61d4d0e4-65bc-40d5-a299-b4324807e48f",
      "name": "If"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "d2ba346e-0584-415f-ae6d-5d1cd0444d62",
              "leftValue": "={{ $('Webhook').item.json.body['auth[application_token]'] }}",
              "rightValue": "={{ $vars.BitrixAuthToken }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        448,
        -256
      ],
      "id": "efcd2e36-aa2c-410c-82fc-a6f4d0a1412b",
      "name": "If1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://b24-ij8x6k.bitrix24.ru/rest/1/gaf0kcmnfmk8qrx3/crm.deal.get.json",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={ \"id\": \"{{$json.dealId}}\" }",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        896,
        -352
      ],
      "id": "c1053ce5-f896-4f36-a316-d7d25fbd71e9",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "jsCode": "const b = $json.body;\nreturn {\n  event: b.event,\n  dealId: b['data[FIELDS][ID]'],\n  token: b['auth[application_token]'],\n  domain: b['auth[domain]'],\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        672,
        -352
      ],
      "id": "d24f2b15-6b73-4bb5-a659-56361025e3e4",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "15939436-cbb9-4c41-a09b-baa34b4cfc39",
              "leftValue": "={{ $json.result.STAGE_ID }}",
              "rightValue": "NEW",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1120,
        -352
      ],
      "id": "ef5cbc39-f6be-4289-8fb2-4064ccd05bd4",
      "name": "If2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e1fdf573-2017-4141-b332-2426f5d096ca",
              "name": "dealId",
              "value": "={{ $json.result.ID }}",
              "type": "string"
            },
            {
              "id": "2d575758-b770-46f7-af6e-983e9dd2726e",
              "name": "violationUrl",
              "value": "={{ $json.result.UF_CRM_1755087848686 }}",
              "type": "string"
            },
            {
              "id": "1fe387ec-1baf-45b6-a278-67c7a9aa2bc8",
              "name": "authorRaw",
              "value": "={{ $json.result.UF_CRM_1755165943 }}",
              "type": "string"
            },
            {
              "id": "a8408144-6442-41be-9997-eaf77ccbbcd8",
              "name": "respondentNote",
              "value": "={{ $json.result.UF_CRM_1755166358 }}",
              "type": "string"
            },
            {
              "id": "9678fd3a-98fc-4bfd-a08a-2dc2d99d10da",
              "name": "companyId",
              "value": "={{ $json.result.COMPANY_ID }}",
              "type": "string"
            },
            {
              "id": "28a6b6dc-76c9-4ac9-9fb5-3f2f5008a935",
              "name": "contactId",
              "value": "={{ $json.result.CONTACT_ID }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1344,
        -448
      ],
      "id": "5a907f54-bb2a-4268-bace-df7e5ab058cd",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "jsCode": "// –ë–µ—Ä—ë–º –ø–æ–ª—è –∏–∑ —Ç–µ–∫—É—â–µ–π –Ω–æ–¥—ã\nconst dealId       = $json.dealId || \"‚Äî\";\nconst dealTitle    = $json.dealTitle || \"‚Äî\";\nconst violationUrl = $json.violationUrl || \"‚Äî\";\nconst evidenceLink = $json.evidenceLink || \"‚Äî\";\nconst authorRaw    = ($json.authorRaw || \"\").toString().trim();\n\n// –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ñ–∞–º–∏–ª–∏—é –∞–≤—Ç–æ—Ä–∞\nconst author = authorRaw ? authorRaw[0].toUpperCase() + authorRaw.slice(1).toLowerCase() : \"–ê–≤—Ç–æ—Ä\";\n\n// –ü—ã—Ç–∞–µ–º—Å—è –¥–æ—Å—Ç–∞—Ç—å email –∏–∑ –∑–∞–º–µ—á–∞–Ω–∏—è\nconst note = ($json.respondentNote || \"\").toString();\nconst emailMatch = note.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,}/i);\nconst emailTo = emailMatch ? emailMatch[0] : \"info@example.com\";\n\nconst subject = `–ü—Ä–µ—Ç–µ–Ω–∑–∏—è –ø–æ –Ω–∞—Ä—É—à–µ–Ω–∏—é ‚Ññ${dealId}`;\n\nconst body = `–î–æ–±—Ä—ã–π –¥–µ–Ω—å!\n–ù–∞—Å—Ç–æ—è—â–∏–º –ø–∏—Å—å–º–æ–º —Å–æ–æ–±—â–∞–µ–º, —á—Ç–æ –Ω–∞ —Å–∞–π—Ç–µ, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä—É–µ–º–æ–º –í–∞–º–∏ ‚Äî ${violationUrl} ‚Äî —Ä–∞–∑–º–µ—â–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∞–≤—Ç–æ—Ä–æ–º –∫–æ—Ç–æ—Ä–æ–≥–æ —è–≤–ª—è–µ—Ç—Å—è ${author}, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ, –æ–±–ª–∞–¥–∞—é—â–∏–π –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ.\n–°–æ–≥–ª–∞—Å–Ω–æ –¥–æ–≥–æ–≤–æ—Ä—É –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –Ω–∞ –¥–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞–Ω—ã –≤ –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ò–ü –ë–æ–≥–¥–∞–Ω –ù–∞—Ç–∞–ª—å–µ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–Ω–µ, –∫–æ—Ç–æ—Ä–∞—è —É–ø–æ–ª–Ω–æ–º–æ—á–µ–Ω–∞ –æ—Ç –∏–º–µ–Ω–∏ –ø—Ä–∞–≤–æ–æ–±–ª–∞–¥–∞—Ç–µ–ª—è –ø—Ä–∏–Ω–∏–º–∞—Ç—å –º–µ—Ä—ã –ø–æ –∑–∞—â–∏—Ç–µ –∞–≤—Ç–æ—Ä—Å–∫–∏—Ö –ø—Ä–∞–≤.\n–§–∞–∫—Ç –Ω–µ–∑–∞–∫–æ–Ω–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω, –≤ —Ç–æ–º —á–∏—Å–ª–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞–º–∏ –∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –∞—Ä—Ö–∏–≤–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –±–µ–∑ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∞, –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –∞–≤—Ç–æ—Ä—Å—Ç–≤–∞ –∏ –≤ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö —Ü–µ–ª—è—Ö (–¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ —É—Å–ª—É–≥–∏) –Ω–∞—Ä—É—à–∞–µ—Ç –ø–æ–ª–æ–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–µ–π 1229, 1259, 1270 –∏ 1301 –ì–ö –†–§ –∏ —è–≤–ª—è–µ—Ç—Å—è –Ω–µ–∑–∞–∫–æ–Ω–Ω—ã–º.\n\n–í —Å–≤—è–∑–∏ —Å —ç—Ç–∏–º —Ç—Ä–µ–±—É–µ–º:\n1. –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–µ–∫—Ä–∞—Ç–∏—Ç—å –ª—é–±–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è;\n2. –í —Ç–µ—á–µ–Ω–∏–µ 10 –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω–µ–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–µ –Ω–∞–ª–∏—á–∏–µ —É –í–∞—Å –ø—Ä–∞–≤ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–µ—Å–ª–∏ —Ç–∞–∫–æ–≤—ã–µ –∏–º–µ—é—Ç—Å—è);\n3. –í —Ç–µ—á–µ–Ω–∏–µ 10 –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω–µ–π –≤—ã–ø–ª–∞—Ç–∏—Ç—å –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—é –≤ —Ä–∞–∑–º–µ—Ä–µ 50 000 —Ä—É–±–ª–µ–π –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∞–≤ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.\n\n–í —Å–ª—É—á–∞–µ –æ—Ç–∫–∞–∑–∞ –æ—Ç –¥–æ—Å—É–¥–µ–±–Ω–æ–≥–æ —É—Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π, –º—ã –±—É–¥–µ–º –≤—ã–Ω—É–∂–¥–µ–Ω—ã –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ —Å—É–¥ —Å –∏—Å–∫–æ–º –æ –≤–∑—ã—Å–∫–∞–Ω–∏–∏ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏, —Å—É–¥–µ–±–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –∏ –≥–æ—Å–ø–æ—à–ª–∏–Ω—ã. –û–±—Ä–∞—â–∞–µ–º –≤–Ω–∏–º–∞–Ω–∏–µ, —á—Ç–æ —Å—É–¥–µ–±–Ω—ã–µ –∏–∑–¥–µ—Ä–∂–∫–∏ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–≤–µ–ª–∏—á–∞—Ç –≤–∞—à—É —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∏ —Å–æ—Å—Ç–∞–≤—è—Ç –æ—Ç 70 000 —Ä—É–±–ª–µ–π, –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö:\n- –æ—Ç 20 000 —Ä—É–±.  - –Ω–µ–∑–∞–∫–æ–Ω–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ;\n- –æ—Ç 20 000 —Ä—É–±.  - –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–µ–∑ —Å–æ–≥–ª–∞—Å–∏—è;\n- 20 000 —Ä—É–±. - —Å—É–¥–µ–±–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã (–≥–æ—Å–ø–æ—à–ª–∏–Ω–∞, —é—Ä. —É—Å–ª—É–≥–∏);\n- –æ—Ç 10 000 —Ä—É–±. - –∑–∞ –¥–ª–∏—Ç–µ–ª—å–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —É–∫–∞–∑–∞–Ω–∏—è –∞–≤—Ç–æ—Ä—Å—Ç–≤–∞.\n–ú—ã, –æ–¥–Ω–∞–∫–æ, –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω—ã –≤ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏ —Å–ø–æ—Ä–∞ –≤ –¥–æ—Å—É–¥–µ–±–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ –∏ –≥–æ—Ç–æ–≤—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –ø–æ –¥–∞–Ω–Ω–æ–º—É –¥–µ–ª—É, –∞ —Ç–∞–∫–∂–µ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã.\n\n–° —É–≤–∞–∂–µ–Ω–∏–µ–º,\n–ë–æ–≥–¥–∞–Ω –ù–∞—Ç–∞–ª—å—è –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–Ω–∞\n+7 (986) 089-03-52\n+7 953 452-89-35\n@BogdanNatalya\n89534528935b@mail.ru`;\n\nreturn {\n  dealId,\n  emailTo,\n  subject,\n  body,\n  violationUrl,\n  evidenceLink\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2464,
        -544
      ],
      "id": "7a287b9e-ced1-4c84-96c1-f00d6133ad24",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://b24-ij8x6k.bitrix24.ru/rest/1/gaf0kcmnfmk8qrx3/crm.company.get.json",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "id",
              "value": "={{$json.companyId}}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1792,
        -544
      ],
      "id": "f0335fc1-8e4e-4fd9-b46e-0940880fb98f",
      "name": "HTTP Request1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "a0113e90-4d8e-47c1-8568-12abcb22ad45",
              "leftValue": "={{ $json.companyId }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1568,
        -448
      ],
      "id": "f83eb32f-ede6-40b5-86ce-17eb83a67385",
      "name": "If3"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c215033a-f77f-458a-a8b2-de9c7210c211",
              "name": "companyName",
              "value": "={{ $json.result.TITLE }}",
              "type": "string"
            },
            {
              "id": "24c86938-fcb3-4617-b521-e3c1bd0f89bb",
              "name": "companyEmail",
              "value": "={{$json.result.EMAIL && $json.result.EMAIL[0]?.VALUE}}",
              "type": "string"
            },
            {
              "id": "d36d3995-8f0b-4317-835e-4db45524eab4",
              "name": "companyPhone",
              "value": "={{$json.result.PHONE && $json.result.PHONE[0]?.VALUE}}",
              "type": "string"
            },
            {
              "id": "f7bdaa44-59ee-4b79-b3ca-32d7a5a2152a",
              "name": "dealId",
              "value": "={{ $('If3').item.json.dealId }}",
              "type": "string"
            },
            {
              "id": "0957141d-8990-447f-87ba-8e5bb36de678",
              "name": "violationUrl",
              "value": "={{ $('Edit Fields').item.json.violationUrl }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2016,
        -544
      ],
      "id": "4a8099b6-14cd-472e-bddc-1a2775a503e8",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "jsCode": "const payload = {\n  CompanyName: $json.companyName || '‚Äî',\n  CompanyINN: $json.companyINN || '',\n  CompanyOGRN: $json.companyOGRN || '',\n  CompanyAddress: $json.companyAddress || '',\n  Director: $json.companyDirector || '',\n  AuthorName: $json.authorRaw || '',\n  ViolationURL: $json.violationUrl || '',\n  CompensationSum: '50000',\n  RightholderName: '–ò–ü –ë–æ–≥–¥–∞–Ω –ù–∞—Ç–∞–ª—å—è –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–Ω–∞',\n  RightholderPhone: '+7 (986) 089-03-52',\n  RightholderEmail: '89534528935b@mail.ru',\n  TodayDate: new Date().toLocaleDateString('ru-RU')\n};\n\nreturn [{\n  ...$json,  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –í–°–ï –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ, –≤–∫–ª—é—á–∞—è dealId\n  emailTo: $json.companyEmail || '',\n  apitemplatePayload: payload,\n  outputFile: `pretension_${$json.dealId}.pdf`\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2240,
        -544
      ],
      "id": "3f859e0a-1e6d-4431-aad8-8a248560e093",
      "name": "Code in JavaScript2"
    },
    {
      "parameters": {
        "resource": "pdf",
        "pdfTemplateId": "ca377b23e3bd7914",
        "jsonParameters": true,
        "download": true,
        "binaryProperty": "={{ $json.outputFile || `pretension_${$json.dealId || $json.companyName || 'doc'}.pdf` }}",
        "propertiesJson": "={\n  \"CompanyName\": \"{{ $node['Code in JavaScript2'].json.apitemplatePayload?.CompanyName || $node['Code in JavaScript2'].json.companyName || '' }}\",\n  \"CompanyINN\": \"{{ $node['Code in JavaScript2'].json.apitemplatePayload?.CompanyINN || '' }}\",\n  \"CompanyOGRN\": \"{{ $node['Code in JavaScript2'].json.apitemplatePayload?.CompanyOGRN || '' }}\",\n  \"CompanyAddress\": \"{{ $node['Code in JavaScript2'].json.apitemplatePayload?.CompanyAddress || '' }}\",\n  \"CompanyEmail\": \"{{ $node['Code in JavaScript2'].json.companyEmail || '' }}\",\n  \"Director\": \"{{ $node['Code in JavaScript2'].json.apitemplatePayload?.Director || '' }}\",\n  \"AuthorName\": \"{{ $node['Code in JavaScript2'].json.apitemplatePayload?.AuthorName || '' }}\",\n\n  \"ViolationCompanyName\": \"{{ $node['Code in JavaScript2'].json.companyName || '' }}\",\n  \"ViolationCompanyURL\": \"{{ $('Code in JavaScript2').item.json.apitemplatePayload.ViolationURL }}\",\n  \"ViolationURL\": \"{{ $node['Code in JavaScript2'].json.apitemplatePayload?.ViolationURL || $node['Code in JavaScript1'].json.violationUrl || '' }}\",\n\n  \"CompensationSum\": \"{{ String($node['Code in JavaScript2'].json.apitemplatePayload?.CompensationSum ?? 50000).replace(/\\\\B(?=(\\\\d{3})+(?!\\\\d))/g, ' ') }}\",\n\n  \"RightholderName\": \"{{ $node['Code in JavaScript2'].json.apitemplatePayload?.RightholderName || '–ò–ü –ë–æ–≥–¥–∞–Ω –ù–∞—Ç–∞–ª—å—è –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–Ω–∞' }}\",\n  \"RightholderINN\": \"562302322881\",\n  \"RightholderOGRNIP\": \"323565800000756\",\n  \"RightholderAddress\": \"–ú–æ—Å–∫–≤–∞, —É–ª. –í–µ—Ä—Ö–Ω–∏–µ –ü–æ–ª—è, –¥. 28\",\n  \"RightholderEmail\": \"{{ $node['Code in JavaScript2'].json.apitemplatePayload?.RightholderEmail || '89534528935b@mail.ru' }}\",\n  \"RightholderPhone\": \"{{ $node['Code in JavaScript2'].json.apitemplatePayload?.RightholderPhone || '+7 (986) 089-03-52' }}\",\n\n  \"Date\": \"{{ $node['Code in JavaScript2'].json.apitemplatePayload?.TodayDate || (new Date()).toLocaleDateString('ru-RU') }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.apiTemplateIo",
      "typeVersion": 1,
      "position": [
        3104,
        -544
      ],
      "id": "f80de337-f587-4cb8-9518-8c276bdb8cb1",
      "name": "Create a pdf",
      "credentials": {
        "apiTemplateIoApi": {
          "id": "sXOX2vUdSL69JMtj",
          "name": "APITemplate.io account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ac11f924-c753-4c5b-bb90-fdcf5e5ba188",
              "leftValue": "={{ $json.status }}",
              "rightValue": "success",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "5aab23fa-8e3c-4737-b851-faef011ce9ca",
              "leftValue": "={{ $json.download_url }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3328,
        -544
      ],
      "id": "d4304340-dda2-4142-b09b-ae1bbd15796f",
      "name": "If4"
    },
    {
      "parameters": {
        "operation": "binaryToPropery",
        "destinationKey": "attachment",
        "options": {
          "encoding": "base64"
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        3776,
        -640
      ],
      "id": "2a3df79e-fadd-419b-a83c-7b20c0643c13",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "url": "={{ $json.download_url }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3552,
        -640
      ],
      "id": "3ef74558-b508-49e7-a551-c4ef3bb15e10",
      "name": "HTTP Request3"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "08ff668c-2238-415e-a76b-7e25f63ca51d",
              "name": "subject",
              "value": "={{ $('Code in JavaScript1').item.json.subject }}",
              "type": "string"
            },
            {
              "id": "04711a45-b99c-4cd4-b060-487619d245b8",
              "name": "body",
              "value": "={{ $('Code in JavaScript1').item.json.body }}",
              "type": "string"
            },
            {
              "id": "67c5d670-d426-4fb3-a1e4-6880d9597aeb",
              "name": "emailTo",
              "value": "=alexsabinovcom@gmail.com",
              "type": "string"
            },
            {
              "id": "585573a0-d417-46a8-977d-0ade8d39c585",
              "name": "dealId",
              "value": "={{ $('If3').item.json.dealId }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4000,
        -640
      ],
      "id": "bd42797e-6f22-473f-b396-d8e26dcea602",
      "name": "Edit Fields2",
      "retryOnFail": true
    },
    {
      "parameters": {
        "fromEmail": "89534528935b@mail.ru",
        "toEmail": "={{ $json.emailTo }}",
        "subject": "={{ $node['Code in JavaScript1'].json.subject }}",
        "emailFormat": "text",
        "text": "={{ $node['Code in JavaScript1'].json.body }}",
        "options": {
          "attachments": "=attachment"
        }
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        4448,
        -640
      ],
      "id": "6348e96c-1621-4c1d-a763-9be116b4dacb",
      "name": "Send email",
      "webhookId": "00e0468e-3221-4865-9a9f-23cc2062f410",
      "credentials": {
        "smtp": {
          "id": "Ck4E1tx2IrXdypco",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "return [{\n  errorType: \"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ\",\n  errorReason: \"–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ: \" + ($('Webhook').item.json.body.event || \"undefined\"),\n  event: $('Webhook').item.json.body.event || \"N/A\",\n  domain: $('Webhook').item.json.body['auth[domain]'] || \"N/A\",\n  timestamp: new Date().toISOString(),\n  severity: \"low\"\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        416,
        32
      ],
      "id": "3d792f13-9201-47e6-bc7a-ee11807e7b16",
      "name": "Code in JavaScript4"
    },
    {
      "parameters": {
        "jsCode": "return [{\n  errorType: \"üî¥ –ü–æ–ø—ã—Ç–∫–∞ –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞\",\n  errorReason: \"–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏\",\n  receivedToken: $('Webhook').item.json.body['auth[application_token]'] || \"N/A\",\n  domain: $('Webhook').item.json.body['auth[domain]'] || \"N/A\",\n  ip: $('Webhook').item.json.headers['x-real-ip'] || \"N/A\",\n  timestamp: new Date().toISOString(),\n  severity: \"critical\"\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        672,
        -160
      ],
      "id": "22de1dc1-36ac-42f3-9e0a-050c777b71a6",
      "name": "Code in JavaScript5"
    },
    {
      "parameters": {
        "jsCode": "const deal = $('HTTP Request').item.json.result;\n\nreturn [{\n  errorType: \"–°–¥–µ–ª–∫–∞ –Ω–µ –≤ —Å—Ç–∞–¥–∏–∏ NEW\",\n  errorReason: \"–°–¥–µ–ª–∫–∞ –ø—Ä–æ–ø—É—â–µ–Ω–∞, —Ç–∞–∫ –∫–∞–∫ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å—Ç–∞–¥–∏–∏: \" + (deal.STAGE_ID || \"Unknown\"),\n  dealId: deal.ID || \"N/A\",\n  dealTitle: deal.TITLE || \"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è\",\n  currentStage: deal.STAGE_ID || \"Unknown\",\n  timestamp: new Date().toISOString(),\n  severity: \"info\"\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1344,
        -256
      ],
      "id": "5b1b76ed-b229-4ee1-97fd-d6956c164736",
      "name": "Code in JavaScript6"
    },
    {
      "parameters": {
        "jsCode": "return [{\n  errorType: \"–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–º–ø–∞–Ω–∏—è\",\n  errorReason: \"–£ —Å–¥–µ–ª–∫–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –∫–æ–º–ø–∞–Ω–∏—è\",\n  dealId: $json.dealId || \"N/A\",\n  contactId: $json.contactId || \"N/A\",\n  timestamp: new Date().toISOString(),\n  severity: \"medium\"\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1792,
        -352
      ],
      "id": "bf637c7c-c85a-4d20-a72a-3eb6bd846702",
      "name": "Code in JavaScript7"
    },
    {
      "parameters": {
        "jsCode": "return [{\n  errorType: \"üî¥ –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF\",\n  errorReason: \"APITemplate.io –Ω–µ —Å–º–æ–≥ —Å–æ–∑–¥–∞—Ç—å PDF\",\n  dealId: $('If3').json.dealId || \"N/A\",\n  pdfStatus: $('Create a pdf').item.json.status || \"unknown\",\n  pdfError: $('Create a pdf').item.json.error || \"No error details\",\n  timestamp: new Date().toISOString(),\n  severity: \"critical\"\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3552,
        -448
      ],
      "id": "23144035-1233-4f53-b628-27f8581a3cd3",
      "name": "Code in JavaScript8"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e8430512-8af0-481b-9b95-780be260e601",
              "leftValue": "={{ $json.accepted[0] }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4896,
        -640
      ],
      "id": "0091627b-f43e-4185-bb9d-fef4db829cee",
      "name": "If6"
    },
    {
      "parameters": {
        "jsCode": "// –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ email\nconst emailResult = {\n  accepted: $json.accepted || [],\n  rejected: $json.rejected || [],\n  messageId: $json.messageId || \"N/A\",\n  response: $json.response || \"\"\n};\n\n// –î–∞–Ω–Ω—ã–µ –∏–∑ Code in JavaScript3\nconst bitrixPayload = $('Code in JavaScript3').item.json;\n\n// –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å dealId –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤\nlet dealId = \"0\";\n\ntry {\n  dealId = $('Edit Fields2').item.json.dealId || \n           bitrixPayload.fields.OWNER_ID || \n           \"0\";\n} catch (e) {\n  console.log(\"Error getting dealId:\", e.message);\n}\n\n// –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å emailTo\nlet emailTo = \"N/A\";\ntry {\n  emailTo = $('Edit Fields2').item.json.emailTo || \"N/A\";\n} catch (e) {\n  console.log(\"Error getting emailTo:\", e.message);\n}\n\n// –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å companyName\nlet companyName = \"N/A\";\ntry {\n  companyName = $('Edit Fields1').item.json.companyName || \"N/A\";\n} catch (e) {\n  console.log(\"Error getting companyName:\", e.message);\n}\n\n// –û–±—ä–µ–¥–∏–Ω—è–µ–º\nreturn [{\n  // Email —Ä–µ–∑—É–ª—å—Ç–∞—Ç\n  accepted: emailResult.accepted,\n  rejected: emailResult.rejected,\n  messageId: emailResult.messageId,\n  response: emailResult.response,\n  emailSuccess: emailResult.accepted.length > 0 && emailResult.rejected.length === 0,\n  \n  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n  dealId: dealId,\n  emailTo: emailTo,\n  companyName: companyName,\n  \n  // –î–∞–Ω–Ω—ã–µ –¥–ª—è –ë–∏—Ç—Ä–∏–∫—Å\n  fields: bitrixPayload.fields,\n  params: bitrixPayload.params\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4672,
        -640
      ],
      "id": "9450338c-013f-48d9-b482-3c95667fa634",
      "name": "Code in JavaScript9"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://b24-ij8x6k.bitrix24.ru/rest/1/gaf0kcmnfmk8qrx3/crm.deal.update.json",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5792,
        -640
      ],
      "id": "05c9d63a-e473-4045-aec8-1bce3c93960d",
      "name": "HTTP Request4"
    },
    {
      "parameters": {
        "jsCode": "return [{\n  id: $json.dealId,\n  fields: {\n    STAGE_ID: \"PREPARATION\",\n    COMMENTS: \n      \"‚úÖ –ü—Ä–µ—Ç–µ–Ω–∑–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏\\n\\n\" +\n      \"–í—Ä–µ–º—è: \" + new Date().toLocaleString('ru-RU') + \"\\n\" +\n      \"–ü–æ–ª—É—á–∞—Ç–µ–ª—å: \" + $json.emailTo + \"\\n\" +\n      \"Message ID: \" + ($json.messageId || \"N/A\")\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5120,
        -640
      ],
      "id": "25500169-e7ed-4212-98ec-0e3275c0d880",
      "name": "Code in JavaScript10"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "27b1928a-1fe5-4cb4-82f3-e897da464ff4",
              "leftValue": "={{ $json.fields.STAGE_ID }}",
              "rightValue": "PREPARATION",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        5344,
        -640
      ],
      "id": "5d128a38-5239-44de-ba3e-4a29bf87777c",
      "name": "If5"
    },
    {
      "parameters": {
        "jsCode": "return [{\n  id: $('Code in JavaScript9').item.json.dealId || \"2420\",\n  fields: {\n    STAGE_ID: \"PREPARATION\",\n    COMMENTS: \n      \"‚úÖ –ü—Ä–µ—Ç–µ–Ω–∑–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏\\n\\n\" +\n      \"–í—Ä–µ–º—è: \" + new Date().toLocaleString('ru-RU') + \"\\n\" +\n      \"–ü–æ–ª—É—á–∞—Ç–µ–ª—å: \" + ($('Code in JavaScript9').item.json.emailTo || \"N/A\") + \"\\n\" +\n      \"Message ID: \" + ($('Code in JavaScript9').item.json.messageId || \"N/A\")\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5568,
        -640
      ],
      "id": "9db41cc7-8115-405a-be97-8f73439475b2",
      "name": "Code in JavaScript11"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "d49dfc85-ee55-44dc-9238-1d8d6320f938",
              "leftValue": "={{ $json.result }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        6016,
        -640
      ],
      "id": "b4f3dbc6-6454-423e-adba-469135e47d95",
      "name": "If7"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://b24-ij8x6k.bitrix24.ru/rest/1/gaf0kcmnfmk8qrx3/tasks.task.add.json",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{\n  {\n    \"fields\": {\n      \"TITLE\": \"–ö–æ–Ω—Ç—Ä–æ–ª—å –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –ø—Ä–µ—Ç–µ–Ω–∑–∏—é #\" + $('Edit Fields3').item.json.dealId + \" (–î–µ–Ω—å 3)\",\n      \"DESCRIPTION\": \n        \"–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –ø—Ä–µ—Ç–µ–Ω–∑–∏—é —á–µ—Ä–µ–∑ 3 –¥–Ω—è\\n\\n\" +\n        \"–°–¥–µ–ª–∫–∞: #\" + $('Edit Fields3').item.json.dealId + \"\\n\" +\n        \"–ö–æ–º–ø–∞–Ω–∏—è: \" + $('Edit Fields3').item.json.companyName + \"\\n\" +\n        \"Email: \" + $('Edit Fields3').item.json.emailTo + \"\\n\" +\n        \"–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: \" + new Date().toLocaleDateString('ru-RU') + \"\\n\" +\n        \"Message ID: \" + $('Edit Fields3').item.json.messageId + \"\\n\\n\" +\n        \"–ó–∞–¥–∞—á–∏:\\n\" +\n        \"1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—á—Ç—É –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—Ç–≤–µ—Ç–∞\\n\" +\n        \"2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞—Ä—É—à–µ–Ω–∏—è –ø–æ —Å—Å—ã–ª–∫–µ\\n\" +\n        \"3. –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–µ—Ç - –æ–∂–∏–¥–∞—Ç—å –¥–æ 5 –¥–Ω–µ–π\",\n      \"RESPONSIBLE_ID\": 1,\n      \"PRIORITY\": 1,\n      \"DEADLINE\": new Date(Date.now() + 3 * 24 * 3600000).toISOString(),\n      \"UF_CRM_TASK\": [\"D_\" + $('Edit Fields3').item.json.dealId],\n      \"TAGS\": [\"pretension_control\", \"day_3\"]\n    }\n  }\n}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6464,
        -640
      ],
      "id": "7368f20e-8dc1-4dfa-a34c-6fa382a9c21f",
      "name": "HTTP Request5"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "41a3e23a-0fc1-42fa-8ada-d0eb4b94c466",
              "name": "dealId",
              "value": "={{ $('If6').item.json.dealId }}",
              "type": "string"
            },
            {
              "id": "8a09340f-1fc3-4d88-a3f9-0e37a9615797",
              "name": "emailTo",
              "value": "={{ $('If6').item.json.emailTo }}",
              "type": "string"
            },
            {
              "id": "f3073588-07d2-438c-8f6f-d728d6b8cb0a",
              "name": "companyName",
              "value": "={{ $('If6').item.json.companyName }}",
              "type": "string"
            },
            {
              "id": "0c3cadc1-99ec-4ba0-ac76-19270164d8f3",
              "name": "messageId",
              "value": "={{ $('If6').item.json.messageId }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6240,
        -640
      ],
      "id": "5320bf7c-9a26-4507-bfda-8e26f9a35bad",
      "name": "Edit Fields3"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "41a3e23a-0fc1-42fa-8ada-d0eb4b94c466",
              "name": "dealId",
              "value": "={{ $('If6').item.json.dealId }}",
              "type": "string"
            },
            {
              "id": "8a09340f-1fc3-4d88-a3f9-0e37a9615797",
              "name": "emailTo",
              "value": "={{ $('If6').item.json.emailTo }}",
              "type": "string"
            },
            {
              "id": "f3073588-07d2-438c-8f6f-d728d6b8cb0a",
              "name": "companyName",
              "value": "={{ $('If6').item.json.companyName }}",
              "type": "string"
            },
            {
              "id": "0c3cadc1-99ec-4ba0-ac76-19270164d8f3",
              "name": "messageId",
              "value": "={{ $('If6').item.json.messageId }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6688,
        -640
      ],
      "id": "6cbd6811-afa6-49eb-980e-77a67924b768",
      "name": "Edit Fields4"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://b24-ij8x6k.bitrix24.ru/rest/1/gaf0kcmnfmk8qrx3/tasks.task.add.json",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ \n  {\n    \"fields\": {\n      \"TITLE\": \"–ö–æ–Ω—Ç—Ä–æ–ª—å –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –ø—Ä–µ—Ç–µ–Ω–∑–∏—é #\" + $('Edit Fields4').item.json.dealId + \" (–î–µ–Ω—å 5)\",\n      \"DESCRIPTION\":\n        \"–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –ø—Ä–µ—Ç–µ–Ω–∑–∏—é —á–µ—Ä–µ–∑ 5 –¥–Ω–µ–π\\n\\n\" +\n        \"–°–¥–µ–ª–∫–∞: #\" + $('Edit Fields4').item.json.dealId + \"\\n\" +\n        \"–ö–æ–º–ø–∞–Ω–∏—è: \" + $('Edit Fields4').item.json.companyName + \"\\n\" +\n        \"Email: \" + $('Edit Fields4').item.json.emailTo + \"\\n\" +\n        \"–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: \" + new Date().toLocaleDateString('ru-RU') + \"\\n\" +\n        \"Message ID: \" + $('Edit Fields4').item.json.messageId + \"\\n\\n\" +\n        \"–ó–∞–¥–∞—á–∏:\\n\" +\n        \"1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—á—Ç—É –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—Ç–≤–µ—Ç–∞\\n\" +\n        \"2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞—Ä—É—à–µ–Ω–∏—è –ø–æ —Å—Å—ã–ª–∫–µ\\n\" +\n        \"3. –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–µ—Ç ‚Äî –≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ –¥–Ω—é 10\",\n      \"RESPONSIBLE_ID\": 1,\n      \"PRIORITY\": 1,\n      \"DEADLINE\": new Date(Date.now() + 5 * 24 * 3600000).toISOString(),\n      \"UF_CRM_TASK\": [\"D_\" + $('Edit Fields4').item.json.dealId],\n      \"TAGS\": [\"pretension_control\", \"day_5\"]\n    }\n  }\n}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6912,
        -640
      ],
      "id": "5570d20b-3128-4581-99c7-0320886fcf6e",
      "name": "HTTP Request6"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "41a3e23a-0fc1-42fa-8ada-d0eb4b94c466",
              "name": "dealId",
              "value": "={{ $('If6').item.json.dealId }}",
              "type": "string"
            },
            {
              "id": "8a09340f-1fc3-4d88-a3f9-0e37a9615797",
              "name": "emailTo",
              "value": "={{ $('If6').item.json.emailTo }}",
              "type": "string"
            },
            {
              "id": "f3073588-07d2-438c-8f6f-d728d6b8cb0a",
              "name": "companyName",
              "value": "={{ $('If6').item.json.companyName }}",
              "type": "string"
            },
            {
              "id": "0c3cadc1-99ec-4ba0-ac76-19270164d8f3",
              "name": "messageId",
              "value": "={{ $('If6').item.json.messageId }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7136,
        -640
      ],
      "id": "6ebfa845-ee5a-43dc-bdd4-35f830afe0a5",
      "name": "Edit Fields5"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://b24-ij8x6k.bitrix24.ru/rest/1/gaf0kcmnfmk8qrx3/tasks.task.add.json",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        7584,
        -640
      ],
      "id": "5b7aaf74-5898-4466-8dbb-2438467ff962",
      "name": "HTTP Request7"
    },
    {
      "parameters": {
        "jsCode": "const dealId  = $json.dealId || 0;\nconst company = $json.companyName || '';\nconst email   = $json.emailTo || '';\n\nreturn [{\n  json: {\n    fields: {\n      TITLE: `üî¥ –°–†–û–ß–ù–û: –ö–æ–Ω—Ç—Ä–æ–ª—å –ø—Ä–µ—Ç–µ–Ω–∑–∏–∏ #${dealId} (–î–µ–Ω—å 10 ‚Äî –ö–†–ê–ô–ù–ò–ô –°–†–û–ö)`,\n      DESCRIPTION:\n        \"üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–î–ê–ß–ê: –ò—Å—Ç–µ–∫–∞–µ—Ç —Å—Ä–æ–∫ –¥–æ—Å—É–¥–µ–±–Ω–æ–≥–æ —É—Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è!\\n\\n\" +\n        `–°–¥–µ–ª–∫–∞: #${dealId}\\n–ö–æ–º–ø–∞–Ω–∏—è: ${company}\\nEmail: ${email}\\n` +\n        `–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${new Date().toLocaleDateString('ru-RU')}\\n\\n` +\n        \"–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø:\\n\" +\n        \"1) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –Ω–∞—Ä—É—à–∏—Ç–µ–ª—è\\n\" +\n        \"2) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞—Ä—É—à–µ–Ω–∏—è (—É—Å—Ç—Ä–∞–Ω–µ–Ω–æ/–Ω–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–æ)\\n\" +\n        \"3) –ï–°–õ–ò –ù–ï–¢ –û–¢–í–ï–¢–ê: –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∏—Å–∫ –∏ –ø–µ—Ä–µ–¥–∞—Ç—å —é—Ä–∏—Å—Ç—É\\n\",\n      RESPONSIBLE_ID: 1,\n      PRIORITY: 2,\n      DEADLINE: new Date(Date.now() + 10 * 24 * 3600000).toISOString(),\n      UF_CRM_TASK: [`D_${dealId}`],\n      TAGS: [\"pretension_control\", \"day_10\", \"urgent\"]\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7360,
        -640
      ],
      "id": "32febf05-8339-4c97-8dc1-dfa3d27cfcaa",
      "name": "Code in JavaScript12"
    },
    {
      "parameters": {
        "jsCode": "for (const item of items) {\n  const binaryKeys = Object.keys(item.binary || {});\n  if (binaryKeys.length === 0) continue;\n\n  const firstKey = binaryKeys[0]; // –Ω–∞–ø—Ä–∏–º–µ—Ä, \"pretension_2420.pdf\"\n  item.binary.attachment = item.binary[firstKey]; // —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–∏ –±–∏–Ω–∞—Ä—å –≤ attachment\n\n  // –º–æ–∂–Ω–æ –ø–æ –∂–µ–ª–∞–Ω–∏—é —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä–æ–µ –∏–º—è, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–æ\n  delete item.binary[firstKey];\n}\n\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4224,
        -640
      ],
      "id": "fe536d1d-fd87-4e8d-afbc-e6f6a349b298",
      "name": "Code in JavaScript3"
    },
    {
      "parameters": {
        "url": "https://b24-ij8x6k.bitrix24.ru/~iTToU?&download=1",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file",
              "outputPropertyName": "template"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2672,
        -544
      ],
      "id": "b039a35f-528a-42c5-b99a-a56b5db675ae",
      "name": "HTTP Request2"
    }
  ],
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "neurocrm.core.neuro42.ru",
            "x-request-id": "5218bf8cccda25bf0c8749dda447ecbe",
            "x-real-ip": "10.21.52.15",
            "x-forwarded-for": "10.21.52.15",
            "x-forwarded-host": "neurocrm.core.neuro42.ru",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-scheme": "https",
            "x-scheme": "https",
            "content-length": "379",
            "user-agent": "Bitrix24 Webhook Engine",
            "content-type": "application/x-www-form-urlencoded",
            "accept-encoding": "gzip"
          },
          "params": {},
          "query": {},
          "body": {
            "event": "ONCRMDEALADD",
            "event_handler_id": "48",
            "data[FIELDS][ID]": "2460",
            "ts": "1762331952",
            "auth[domain]": "b24-ij8x6k.bitrix24.ru",
            "auth[client_endpoint]": "https://b24-ij8x6k.bitrix24.ru/rest/",
            "auth[server_endpoint]": "https://oauth.bitrix24.tech/rest/",
            "auth[member_id]": "336857a5ec95a96cc92147c47ec8bb77",
            "auth[application_token]": "363mrzoehwmwf7rizf4g1ie37f376s5y"
          },
          "webhookUrl": "https://neurocrm.core.neuro42.ru/webhook-test/fbc4cb53-5f89-43ac-8cb8-74c12dd8b97b",
          "executionMode": "test"
        }
      }
    ]
  },
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code in JavaScript4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code in JavaScript5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code in JavaScript6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "If3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If3": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code in JavaScript7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request1": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "Code in JavaScript2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript2": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "HTTP Request2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create a pdf": {
      "main": [
        [
          {
            "node": "If4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If4": {
      "main": [
        [
          {
            "node": "HTTP Request3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code in JavaScript8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "Edit Fields2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request3": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields2": {
      "main": [
        [
          {
            "node": "Code in JavaScript3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send email": {
      "main": [
        [
          {
            "node": "Code in JavaScript9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If6": {
      "main": [
        [
          {
            "node": "Code in JavaScript10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript9": {
      "main": [
        [
          {
            "node": "If6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript10": {
      "main": [
        [
          {
            "node": "If5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If5": {
      "main": [
        [
          {
            "node": "Code in JavaScript11",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript11": {
      "main": [
        [
          {
            "node": "HTTP Request4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request4": {
      "main": [
        [
          {
            "node": "If7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If7": {
      "main": [
        [
          {
            "node": "Edit Fields3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields3": {
      "main": [
        [
          {
            "node": "HTTP Request5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request5": {
      "main": [
        [
          {
            "node": "Edit Fields4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields4": {
      "main": [
        [
          {
            "node": "HTTP Request6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request6": {
      "main": [
        [
          {
            "node": "Edit Fields5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields5": {
      "main": [
        [
          {
            "node": "Code in JavaScript12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript12": {
      "main": [
        [
          {
            "node": "HTTP Request7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript3": {
      "main": [
        [
          {
            "node": "Send email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request2": {
      "main": [
        [
          {
            "node": "Create a pdf",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "719359ff-a9f4-4f36-a69b-c688d6535a25",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "5ead4e1777d66c00ab18281081170ab50795af19ccf34609d1033f0baf738ec2"
  },
  "id": "0QdDyCmSIsj3bvIV",
  "tags": []
}